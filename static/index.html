<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>RAG å•ç­”ç³»çµ±</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* ç™»å…¥ç›¸é—œæ¨£å¼ */
        .auth-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .auth-input {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
        }
        .auth-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        .auth-toggle {
            text-align: center;
            margin-top: 15px;
            color: #666;
        }
        .auth-toggle a {
            color: #667eea;
            text-decoration: none;
        }
        .user-info {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }
        .hidden {
            display: none !important;
        }

        /* ä¸»è¦å¸ƒå±€æ¨£å¼ */
        .main-layout {
            display: flex;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* å·¦å´çµ±è¨ˆå€åŸŸ */
        .stats-sidebar {
            width: 300px;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* å³å´ä¸»è¦å…§å®¹å€åŸŸ */
        .main-content {
            flex: 1;
            min-width: 0; /* é˜²æ­¢å…§å®¹æº¢å‡º */
        }

        /* çµ±è¨ˆå€å¡Šæ¨£å¼ */
        .stats-block {
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .user-stats {
            background: linear-gradient(135deg, #e9f7ef 0%, #d4edda 100%);
        }

        .admin-stats {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        }

        .stats-block h3 {
            margin: 0 0 10px 0;
            font-size: 18px;
            color: #333;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
                padding: 10px;
            }
            
            .stats-sidebar {
                width: 100%;
                order: 2; /* åœ¨æ‰‹æ©Ÿä¸Šï¼Œçµ±è¨ˆå€å¡Šç§»åˆ°ä¸‹æ–¹ */
            }
            
            .main-content {
                order: 1;
            }
        }

    </style>
</head>
<body>
    <!-- ç™»å…¥/è¨»å†Šé é¢ -->
    <div class="auth-container" id="authSection">
        <h1 id="authTitle">ç™»å…¥ç³»çµ±</h1>
        
        <form class="auth-form" id="authForm">
            <input type="text" id="username" class="auth-input" placeholder="ä½¿ç”¨è€…åç¨±" required>
            <input type="password" id="password" class="auth-input" placeholder="å¯†ç¢¼" required>
            <button type="submit" class="auth-btn" id="authBtn">ç™»å…¥</button>
        </form>
        
        <div class="auth-toggle">
            <span id="toggleText">é‚„æ²’æœ‰å¸³è™Ÿå—ï¼Ÿ</span>
            <a href="#" id="toggleLink">ç«‹å³è¨»å†Š</a>
        </div>
    </div>

    <!-- ä¸»è¦å•ç­”ç³»çµ± -->
    <div class="main-layout hidden" id="mainSection">
        <!-- å·¦å´çµ±è¨ˆå€åŸŸ -->
        <div class="stats-sidebar">
            <!-- ä½¿ç”¨è€…çµ±è¨ˆè³‡è¨Š -->
            <div class="stats-block user-stats" id="userStats">
                <h3>ğŸ“Š æˆ‘çš„çµ±è¨ˆ</h3>
                <div id="userStatsContent">è®€å–ä¸­...</div>
            </div>

            <!-- ç®¡ç†å“¡çµ±è¨ˆè³‡è¨Šï¼ˆé è¨­éš±è—ï¼‰ -->
            <div class="stats-block admin-stats hidden" id="adminStats">
                <h3>ğŸ›  ç®¡ç†å“¡çµ±è¨ˆ</h3>
                <div id="adminStatsContent">è®€å–ä¸­...</div>
            </div>
        </div>

        <!-- å³å´ä¸»è¦å…§å®¹å€åŸŸ -->
        <div class="main-content">
            <div class="container">
                <h1>è¨ˆç®—æ©Ÿæ¦‚è«–å•ç­”ç³»çµ±</h1>
                <div class="subtitle">åŸºæ–¼è¨ˆç®—æ©Ÿæ¦‚è«–æ•™æçš„å•ç­”ç³»çµ±</div>

                <!-- ä½¿ç”¨è€…è³‡è¨Š -->
                <div class="user-info" id="userInfo">
                    <span>æ­¡è¿ï¼Œ<strong id="currentUser"></strong>ï¼</span>
                    <button class="clear-history-btn" onclick="clearChatHistory()">æ¸…é™¤æ­·å²</button>
                    <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
                </div>

                <div id="systemStatus" class="system-status status-loading">
                    ğŸ”„ æ­£åœ¨åˆå§‹åŒ–ç³»çµ±ï¼Œè«‹ç¨å€™...
                </div>

                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="welcome-message" id="welcomeMessage">
                            ç³»çµ±åˆå§‹åŒ–å®Œæˆå¾Œï¼Œæ‚¨å°±å¯ä»¥é–‹å§‹æå•äº†ï¼
                        </div>
                    </div>
                    <div class="loading-indicator" id="loadingIndicator">
                        ğŸ¤” AI æ­£åœ¨æ€è€ƒä¸­...
                    </div>
                    <div class="input-group">
                        <textarea 
                            class="question-input" 
                            id="questionInput" 
                            placeholder="è«‹è¼¸å…¥æ‚¨çš„å•é¡Œ..."
                            rows="1"
                            disabled
                            onkeydown="handleKeyDown(event)"
                            oninput="autoResize(this)"
                        ></textarea>
                        <button class="send-btn" id="sendBtn" onclick="askQuestion()" disabled>
                            ç™¼é€
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let isSystemReady = false;  // è¨˜éŒ„ç³»çµ±æ˜¯å¦åˆå§‹åŒ–å®Œæˆ
        let isLoginMode = true;     // true:ç™»å…¥æ¨¡å¼ï¼Œfalse:è¨»å†Šæ¨¡å¼
        
        // DOM å…ƒç´ 
        const authSection = document.getElementById('authSection'); // ç™»å…¥å€å¡Š
        const mainSection = document.getElementById('mainSection');// å•ç­”ä¸»é å€å¡Š
        const authForm = document.getElementById('authForm');   // ç™»å…¥/è¨»å†Šè¡¨å–®
        const authTitle = document.getElementById('authTitle'); // æ¨™é¡Œæ–‡å­—ï¼ˆç™»å…¥ç³»çµ± / è¨»å†Šå¸³è™Ÿï¼‰
        const authBtn = document.getElementById('authBtn'); // æäº¤æŒ‰éˆ•ï¼ˆç™»å…¥ / è¨»å†Šï¼‰
        const emailInput = document.getElementById('email');     // ä¿¡ç®±è¼¸å…¥æ¬„ï¼ˆå·²ç§»é™¤ï¼‰
        const toggleText = document.getElementById('toggleText');    // åº•ä¸‹æç¤ºæ–‡å­—
        const toggleLink = document.getElementById('toggleLink');   // åˆ‡æ›ç™»å…¥/è¨»å†Šçš„é€£çµ
        const currentUser = document.getElementById('currentUser'); // é¡¯ç¤ºç›®å‰ä½¿ç”¨è€…åç¨±

        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        function checkAuthStatus() {
            const token = localStorage.getItem('auth_token');   // å¾ localStorage æ‹¿å‡º token
            const userInfo = localStorage.getItem('user_info'); // æ‹¿å‡ºå„²å­˜çš„ä½¿ç”¨è€…è³‡æ–™
            
            if (token && userInfo) {
                // è‹¥éƒ½æœ‰ï¼Œè¡¨ç¤ºç™»å…¥éï¼Œç›´æ¥é€²å…¥ä¸»ç•«é¢
                const user = JSON.parse(userInfo);  // æŠŠå­—ä¸²è½‰æˆç‰©ä»¶
                showMainSection(user);  // é¡¯ç¤ºä¸»ç•«é¢
                initializeSystem(); // å•Ÿå‹•ç³»çµ±åˆå§‹åŒ–
                loadUserStats(); // é¡¯ç¤ºå€‹äººçµ±è¨ˆ
                if (user.is_admin) {
                    loadAdminStats(); // å¦‚æœæ˜¯ç®¡ç†å“¡ï¼Œé¡¯ç¤ºç®¡ç†çµ±è¨ˆ
                }
            } else {
                showAuthSection();  // å¦å‰‡é¡¯ç¤ºç™»å…¥/è¨»å†Šç•«é¢
            }
        }

        // é¡¯ç¤ºç™»å…¥é é¢
        function showAuthSection() {
            authSection.classList.remove('hidden'); // é¡¯ç¤ºç™»å…¥ç•«é¢
            mainSection.classList.add('hidden');    // éš±è—ä¸»ç•«é¢
        }

        // ä¿®æ”¹ showMainSection å‡½æ•¸ï¼Œè¼‰å…¥æ­·å²å¾Œå†è¼‰å…¥çµ±è¨ˆ
        function showMainSection(user) {
            authSection.classList.add('hidden');
            mainSection.classList.remove('hidden');
            currentUser.textContent = user.username;

            // è¼‰å…¥èŠå¤©æ­·å²
            loadChatHistory();
        }

        // ç™»å‡ºåŠŸèƒ½(æŒ‰ä¸‹æŒ‰éˆ•æ™‚è§¸ç™¼)
        function logout() {
            localStorage.removeItem('auth_token');// æ¸…é™¤ token
            localStorage.removeItem('user_info');// æ¸…é™¤ä½¿ç”¨è€…è³‡è¨Š
            location.reload();   // é‡æ–°æ•´ç†é é¢ï¼Œå›åˆ°ç™»å…¥ç•«é¢ï¼Œ
        }

        // ç”¢ç”Ÿèªè­‰ç”¨çš„ HTTP æ¨™é ­ï¼ˆå¤¾å¸¶ tokenï¼‰
        function getAuthHeaders() {
            const token = localStorage.getItem('auth_token');   // æ‹¿ token
            const headers = {
                'Content-Type': 'application/json'   // å‘Šè¨´ä¼ºæœå™¨å‚³é€çš„æ˜¯ JSON æ ¼å¼
            };
            
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;   // åŠ ä¸Š tokenï¼ˆJWTï¼‰åˆ° Authorization æ¬„ä½
            }
            
            return headers;
        }

        // åˆ‡æ›ç™»å…¥/è¨»å†Šæ¨¡å¼
        toggleLink.addEventListener('click', (e) => {
            e.preventDefault(); // é˜²æ­¢é é¢è·³è½‰
            isLoginMode = !isLoginMode;      // åˆ‡æ›æ¨¡å¼
            
            if (isLoginMode) {
                 // åˆ‡æ›å›ã€Œç™»å…¥ã€æ¨¡å¼
                authTitle.textContent = 'ç™»å…¥ç³»çµ±';
                authBtn.textContent = 'ç™»å…¥';
                toggleText.textContent = 'é‚„æ²’æœ‰å¸³è™Ÿå—ï¼Ÿ';
                toggleLink.textContent = 'ç«‹å³è¨»å†Š';
            } else {
                authTitle.textContent = 'è¨»å†Šå¸³è™Ÿ';
                authBtn.textContent = 'è¨»å†Š';
                toggleText.textContent = 'å·²ç¶“æœ‰å¸³è™Ÿäº†ï¼Ÿ';
                toggleLink.textContent = 'ç«‹å³ç™»å…¥';
            }
        });

        // ç™»å…¥/è¨»å†Šè¡¨å–®æäº¤ï¼ˆé»ç™»å…¥/è¨»å†ŠæŒ‰éˆ•ï¼‰
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // é˜»æ­¢è¡¨å–®é è¨­é€å‡ºè¡Œç‚ºï¼ˆä¸æ›é ï¼‰
            
             // æŠ“å–è¼¸å…¥å€¼
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // æ ¹æ“šç›®å‰æ¨¡å¼æ±ºå®šé€åˆ°å“ªå€‹å¾Œç«¯ API
            const endpoint = isLoginMode ? '/login' : '/register';

            // çµ„æˆé€å‡ºçš„è³‡æ–™ç‰©ä»¶ï¼ˆç§»é™¤ emailï¼‰
            const payload = { username, password };
            
            try {
                 // é€å‡º POST è«‹æ±‚åˆ°å¾Œç«¯
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();// å°‡å›æ‡‰è§£æç‚º JSON
                
                if (response.ok) {
                    if (isLoginMode) {
                         // ç™»å…¥æˆåŠŸ â†’ å„²å­˜ token èˆ‡ä½¿ç”¨è€…è³‡æ–™
                        localStorage.setItem('auth_token', result.access_token);
                        localStorage.setItem('user_info', JSON.stringify(result.user_info));
                        showMainSection(result.user_info);// é¡¯ç¤ºä¸»ç•«é¢
                        initializeSystem();               // åˆå§‹åŒ–ç³»çµ±
                        loadUserStats(); // é¡¯ç¤ºå€‹äººçµ±è¨ˆ
                        if (result.user_info.is_admin) {
                            loadAdminStats(); // å¦‚æœæ˜¯ç®¡ç†å“¡ï¼Œé¡¯ç¤ºç®¡ç†çµ±è¨ˆ
                        }
                    } else {
                        alert('è¨»å†ŠæˆåŠŸï¼è«‹ç™»å…¥');
                        toggleLink.click(); // è‡ªå‹•åˆ‡æ›åˆ°ç™»å…¥æ¨¡å¼
                        authForm.reset();   // æ¸…é™¤è¼¸å…¥å…§å®¹
                    }
                } else {
                    // è‹¥ç™»å…¥æˆ–è¨»å†Šå¤±æ•—ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                    alert(result.detail || 'æ“ä½œå¤±æ•—');
                }
            } catch (error) {
                alert('ç¶²è·¯éŒ¯èª¤ï¼š' + error.message);
            }
        });


        async function initializeSystem() {
            const statusDiv = document.getElementById('systemStatus');
            try {
                statusDiv.innerHTML = 'ğŸ”„ æ­£åœ¨è¼‰å…¥æ–‡ä»¶ä¸¦å»ºç«‹å‘é‡è³‡æ–™åº«...';
                statusDiv.className = 'system-status status-loading';
                
                const response = await fetch('/initialize', { 
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    isSystemReady = true;
                    statusDiv.innerHTML = 'âœ… ç³»çµ±å·²å°±ç·’ï¼æ‚¨ç¾åœ¨å¯ä»¥é–‹å§‹æå•äº†';
                    statusDiv.className = 'system-status status-ready';
                    // å•Ÿç”¨è¼¸å…¥æ¡†å’ŒæŒ‰éˆ•
                    document.getElementById('questionInput').disabled = false;
                    document.getElementById('sendBtn').disabled = false;
                    document.getElementById('questionInput').focus();
                    // éš±è—æ­¡è¿è¨Šæ¯
                    document.getElementById('welcomeMessage').style.display = 'none';
                } else {
                    if (response.status === 401) {
                        // Token éæœŸï¼Œé‡æ–°ç™»å…¥
                        logout();
                        return;
                    }
                    const errorMsg = result.detail || result.message || 'æœªçŸ¥éŒ¯èª¤';
                    statusDiv.innerHTML = `âŒ åˆå§‹åŒ–å¤±æ•—ï¼š${errorMsg}`;
                    statusDiv.className = 'system-status status-error';
                }
            } catch (error) {
                statusDiv.innerHTML = `âŒ ç¶²è·¯é€£æ¥éŒ¯èª¤ï¼š${error.message}`;
                statusDiv.className = 'system-status status-error';
            }
        }

        async function loadUserStats() {
            try {
                const res = await fetch('/stats', { headers: getAuthHeaders() });
                const data = await res.json();

                if (res.ok) {
                    document.getElementById('userStatsContent').innerHTML = `
                        ğŸ‘¤ ç¸½æå•æ¬¡æ•¸ï¼š${data.total_questions} <br>
                        ğŸ“… ä»Šæ—¥æå•æ¬¡æ•¸ï¼š${data.questions_today} <br>
                        â± å¹³å‡å›æ‡‰æ™‚é–“ï¼š${data.avg_response_time} ç§’ <br>
                        ğŸ§  å¸¸è¦‹ä¸»é¡Œï¼š${data.most_asked_topics.join(', ')}
                    `;
                } else {
                    document.getElementById('userStatsContent').textContent = 'âŒ ç„¡æ³•è¼‰å…¥ä½¿ç”¨è€…çµ±è¨ˆè³‡æ–™';
                }
            } catch (e) {
                document.getElementById('userStatsContent').textContent = 'âŒ éŒ¯èª¤ï¼š' + e.message;
            }
        }

        async function loadAdminStats() {
            try {
                const res = await fetch('/admin/stats', { headers: getAuthHeaders() });
                const data = await res.json();

                if (res.ok) {
                    document.getElementById('adminStats').classList.remove('hidden');
                    document.getElementById('adminStatsContent').innerHTML = `
                        ğŸ‘¥ ä½¿ç”¨è€…ç¸½æ•¸ï¼š${data.total_users} <br>
                        â“ å•é¡Œç¸½æ•¸ï¼š${data.total_questions} <br>
                        ğŸ“† ä»Šæ—¥å•é¡Œæ•¸ï¼š${data.questions_today}
                    `;
                } else {
                    document.getElementById('adminStatsContent').textContent = 'âŒ ç„¡æ³•è¼‰å…¥ç®¡ç†çµ±è¨ˆè³‡æ–™';
                }
            } catch (e) {
                document.getElementById('adminStatsContent').textContent = 'âŒ éŒ¯èª¤ï¼š' + e.message;
            }
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                askQuestion();
            }
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
        }

        // ä¿®æ”¹ askQuestion å‡½æ•¸ï¼Œç§»é™¤ sources åƒæ•¸
        async function askQuestion() {
            if (!isSystemReady) {
                alert('âš ï¸ ç³»çµ±å°šæœªæº–å‚™å°±ç·’ï¼Œè«‹ç­‰å¾…åˆå§‹åŒ–å®Œæˆ');
                return;
            }
            
            const questionInput = document.getElementById('questionInput');
            const question = questionInput.value.trim();
            if (!question) return;

            // æ·»åŠ ç”¨æˆ¶è¨Šæ¯åˆ°èŠå¤©å€ï¼ˆä¸å«æ™‚é–“æˆ³è¨˜ï¼Œè¡¨ç¤ºæ˜¯æ–°è¨Šæ¯ï¼‰
            addMessage(question, 'user');
            questionInput.value = '';
            questionInput.style.height = 'auto';

            // é¡¯ç¤ºè¼‰å…¥æŒ‡ç¤ºå™¨
            const loadingIndicator = document.getElementById('loadingIndicator');
            const sendBtn = document.getElementById('sendBtn');
            loadingIndicator.classList.add('show');
            sendBtn.disabled = true;
            sendBtn.textContent = 'æ€è€ƒä¸­...';
            questionInput.disabled = true;

            try {
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ question: question })
                });

                if (response.status === 401) {
                    logout();
                    return;
                }

                const result = await response.json();

                if (response.ok) {
                    // ç§»é™¤ sources åƒæ•¸
                    addMessage(result.answer, 'bot');
                    
                    // æ›´æ–°çµ±è¨ˆè³‡æ–™
                    loadUserStats();
                } else {
                    addMessage(`âŒ éŒ¯èª¤ï¼š${result.detail}`, 'bot');
                }
            } catch (error) {
                addMessage(`âŒ ç¶²è·¯éŒ¯èª¤ï¼š${error.message}`, 'bot');
            } finally {
                loadingIndicator.classList.remove('show');
                sendBtn.disabled = false;
                sendBtn.textContent = 'ç™¼é€';
                questionInput.disabled = false;
                questionInput.focus();
            }
        }

        // ä¿®æ”¹ addMessage å‡½æ•¸ï¼Œæ”¯æ´æ™‚é–“æˆ³è¨˜
        function addMessage(content, sender, sources = null, timestamp = null) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            // æ ¼å¼åŒ–æ™‚é–“
            let timeHtml = '';
            if (timestamp) {
                const date = new Date(timestamp);
                timeHtml = `<div class="message-time">${date.toLocaleString('zh-TW')}</div>`;
            }
            
            // ä¾†æºè³‡è¨Šï¼ˆç›®å‰å·²ç¶“ç§»é™¤ï¼Œæ‰€ä»¥é€™éƒ¨åˆ†å¯ä»¥çœç•¥ï¼‰
            let sourcesHtml = '';
            // if (sources && sources.length > 0) {
            //     sourcesHtml = '<div class="sources"><strong>ğŸ“š åƒè€ƒä¾†æºï¼š</strong>';
            //     sources.forEach((source, index) => {
            //         sourcesHtml += `<div class="source-item">
            //             ${index + 1}. ğŸ“„ ${source.source} (ç¬¬ ${source.page} é )
            //             <br><small>å…§å®¹é è¦½ï¼š${source.content_preview}</small>
            //         </div>`;
            //     });
            //     sourcesHtml += '</div>';
            // }

            messageDiv.innerHTML = `
                <div class="message-content">
                    ${content.replace(/\n/g, '<br>')}
                    ${sourcesHtml}
                </div>
                ${timeHtml}
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // è¼‰å…¥èŠå¤©æ­·å²
        async function loadChatHistory() {
            try {
                const response = await fetch('/chat/history?limit=50', {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const chatMessages = document.getElementById('chatMessages');
                    
                    // æ¸…ç©ºç¾æœ‰è¨Šæ¯ï¼ˆé™¤äº†æ­¡è¿è¨Šæ¯ï¼‰
                    chatMessages.innerHTML = '<div class="welcome-message" id="welcomeMessage">ç³»çµ±åˆå§‹åŒ–å®Œæˆå¾Œï¼Œæ‚¨å°±å¯ä»¥é–‹å§‹æå•äº†ï¼</div>';
                    
                    // åå‘éæ­·æ­·å²ç´€éŒ„ï¼ˆå› ç‚ºå¾Œç«¯æ˜¯å€’åºï¼Œå‰ç«¯è¦æ­£åºé¡¯ç¤ºï¼‰
                    data.history.reverse().forEach(item => {
                        addMessage(item.question, 'user', null, item.timestamp);
                        addMessage(item.answer, 'bot', null, item.timestamp);
                    });
                    
                    // å¦‚æœæœ‰æ­·å²ç´€éŒ„ï¼Œéš±è—æ­¡è¿è¨Šæ¯
                    if (data.history.length > 0) {
                        document.getElementById('welcomeMessage').style.display = 'none';
                    }
                    
                    // é¡¯ç¤ºè¼‰å…¥çš„æ­·å²æ•¸é‡
                    console.log(`è¼‰å…¥äº† ${data.history.length} ç­†æ­·å²å°è©±`);
                    
                } else if (response.status === 401) {
                    logout();
                }
            } catch (error) {
                console.error('è¼‰å…¥æ­·å²ç´€éŒ„å¤±æ•—:', error);
            }
        }

        // æ¸…é™¤èŠå¤©æ­·å²
        async function clearChatHistory() {
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰èŠå¤©æ­·å²å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                return;
            }
            
            try {
                const response = await fetch('/chat/history', {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    
                    // æ¸…ç©ºèŠå¤©è¦–çª—
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = '<div class="welcome-message" id="welcomeMessage">ç³»çµ±åˆå§‹åŒ–å®Œæˆå¾Œï¼Œæ‚¨å°±å¯ä»¥é–‹å§‹æå•äº†ï¼</div>';
                    
                    // é‡æ–°è¼‰å…¥çµ±è¨ˆè³‡æ–™
                    loadUserStats();
                    
                } else if (response.status === 401) {
                    logout();
                } else {
                    const error = await response.json();
                    alert('æ¸…é™¤å¤±æ•—ï¼š' + error.detail);
                }
            } catch (error) {
                alert('æ¸…é™¤å¤±æ•—ï¼š' + error.message);
            }
        }

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        window.addEventListener('load', function() {
            checkAuthStatus();
        });
    </script>
</body>
</html>